on:
  pull_request:
  push:
    branches:
      - main

jobs:
  github_check_job:
    runs-on: ubuntu-latest
    steps:
      - name: チェックアウト
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 全てのコミットを取得

      - name: Get PR commits
        id: get-commits
        run: |
          echo "pr_commits<<EOF" >> $GITHUB_OUTPUT
          gh pr list --json commits --template '{{range .}}{{range .commits}}• <${{ github.server_url }}/${{ github.repository }}/commit/{{.oid}}|{{slice .oid 0 7}}> {{.messageHeadline}}
          {{end}}{{end}}' >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate Issue Link
        id: link
        run: |
          BRANCH_NAME="${{ github.head_ref || github.ref_name }}"
          echo "Branch name: $BRANCH_NAME"
          
          # 改良: 数字を抽出し、存在するか確認
          ISSUE_NUMBER=$(echo $BRANCH_NAME | grep -o '^[0-9]\+' || echo "")
          echo "Extracted issue number: '$ISSUE_NUMBER'"
          
          # Issue番号があれば完全なリンクを生成、なければリポジトリのIssuesページへのリンク
          if [ -n "$ISSUE_NUMBER" ]; then
            ISSUE_LINK="https://github.com/${{ github.repository }}/issues/$ISSUE_NUMBER"
            ISSUE_TEXT="#$ISSUE_NUMBER関連Issue"
          else
            ISSUE_LINK="https://github.com/${{ github.repository }}/issues"
            ISSUE_TEXT="Issues一覧"
          fi
          
          echo "issue_link=$ISSUE_LINK" >> $GITHUB_OUTPUT
          echo "issue_text=$ISSUE_TEXT" >> $GITHUB_OUTPUT
          echo "Generated: $ISSUE_LINK"

      - name: テスト結果の Slack 通知
        uses: ravsamhq/notify-slack-action@v2
        if: always()
        with:
          status: ${{ job.status }}
          notification_title: "`${{ job.status == 'success' && '✅' || '❌' }}` ${{ github.event.repository.name }} のテストが${{ job.status == 'success' && '成功しました' || '失敗しました' }}"
          message_format: |
            ブランチ: `${{ github.ref_name }}`
            コミット: `{commit_sha}`

            テスト結果
            > Unitテスト `${{ job.status == 'success' && 'PASS' || 'FAIL' }}`
            > E2Eテスト  `${{ job.status == 'success' && 'PASS' || 'FAIL' }}`
            
            *📋 関連Issue:* <${{ steps.link.outputs.issue_link }}|#${{ github.ref_name }}関連Issue>
            ${{ steps.get-commits.outputs.pr_commits }}

          footer: "<${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|コミット詳細を表示> | <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|ワークフロー実行を表示>"
          notify_when: "success,failure"
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
