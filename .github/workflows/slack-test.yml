on:
  pull_request:
  push:
    branches:
      - main

jobs:
  github_check_job:
    runs-on: ubuntu-latest
    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨ã¦ã®ã‚³ãƒŸãƒƒãƒˆã‚’å–å¾—

      - name: Get PR commits
        id: get-commits
        run: |
          echo "pr_commits<<EOF" >> $GITHUB_OUTPUT
          gh pr list --json commits --template '{{range .}}{{range .commits}}â€¢ <${{ github.server_url }}/${{ github.repository }}/commit/{{.oid}}|{{slice .oid 0 7}}> {{.messageHeadline}}
          {{end}}{{end}}' >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract issue number from branch name
        id: extract-issue
        run: |
          BRANCH_NAME="${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}"
          echo "Branch name: $BRANCH_NAME"
          
          # Extract the issue number from the beginning of the branch name (format: number-description)
          if [[ $BRANCH_NAME =~ ^([0-9]+)- ]]; then
            ISSUE_NUMBER=${BASH_REMATCH[1]}
            echo "ISSUE_NUMBER=$ISSUE_NUMBER" >> $GITHUB_ENV
            echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
            echo "Found issue number: $ISSUE_NUMBER"
          else
            echo "No issue number found in branch name: $BRANCH_NAME"
            echo "ISSUE_NUMBER=none" >> $GITHUB_ENV
            echo "issue_number=none" >> $GITHUB_OUTPUT
          fi

      # PRã®ã‚³ãƒŸãƒƒãƒˆæƒ…å ±ã¨Issueãƒªãƒ³ã‚¯ã‚’å–å¾—ã™ã‚‹ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¿½åŠ 
      - name: Get PR commits with issue link
        id: get-pr-info
        run: |
          ISSUE_NUMBER="${{ steps.extract-issue.outputs.issue_number }}"
          ISSUE_LINK=""
          
          if [ "$ISSUE_NUMBER" != "none" ]; then
            REPO_URL="${{ github.server_url }}/${{ github.repository }}"
            ISSUE_LINK="<${REPO_URL}/issues/${ISSUE_NUMBER}|#${ISSUE_NUMBER}>"
          fi
          
          echo "issue_link=$ISSUE_LINK" >> $GITHUB_OUTPUT

      - name: ãƒ†ã‚¹ãƒˆçµæœã® Slack é€šçŸ¥
        uses: ravsamhq/notify-slack-action@v2
        if: always()
        with:
          status: ${{ job.status }}
          notification_title: "`${{ job.status == 'success' && 'âœ…' || 'âŒ' }}` ${{ github.event.repository.name }} ã®ãƒ†ã‚¹ãƒˆãŒ${{ job.status == 'success' && 'æˆåŠŸã—ã¾ã—ãŸ' || 'å¤±æ•—ã—ã¾ã—ãŸ' }}"
          message_format: |
            ãƒ–ãƒ©ãƒ³ãƒ: `${{ github.ref_name }}`
            ã‚³ãƒŸãƒƒãƒˆ: `{commit_sha}`

            ãƒ†ã‚¹ãƒˆçµæœ
            > Unitãƒ†ã‚¹ãƒˆ `${{ job.status == 'success' && 'PASS' || 'FAIL' }}`
            > E2Eãƒ†ã‚¹ãƒˆ  `${{ job.status == 'success' && 'PASS' || 'FAIL' }}`
            
            *ğŸ“‹ PR ã‚³ãƒŸãƒƒãƒˆ:* ${{ steps.get-pr-info.outputs.issue_link != '' && '(' || '' }}${{ steps.get-pr-info.outputs.issue_link }}${{ steps.get-pr-info.outputs.issue_link != '' && ')' || '' }}            ${{ steps.get-commits.outputs.pr_commits }}

          footer: "<${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|ã‚³ãƒŸãƒƒãƒˆè©³ç´°ã‚’è¡¨ç¤º> | <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œã‚’è¡¨ç¤º>"
          notify_when: "success,failure"
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
